# 管理员创建订单功能 - 使用说明

## 📋 功能概述

本功能允许管理员替会员创建订单（预约课程），适用于当前场景：暂时不开放会员端入口，所有课程预约由管理员操作。

## 🎯 功能特点

1. **管理员替会员预约** - 管理员可以代表会员创建订单
2. **智能余额校验** - 实时检查会员余额是否充足
3. **课程状态检查** - 防止重复预订已被占用的课程
4. **完整的事务管理** - 确保余额扣除、预订创建、支付记录的原子性

## 🚀 使用方法

### 访问路径
- **菜单**: 管理端 → 订单管理 → 订单列表
- **URL**: `/order/list`

### 操作步骤

1. **登录管理员账号**
   - 使用管理员账号登录（userType = '1'）

2. **进入订单列表页面**
   - 点击菜单中的"订单列表"
   - 或直接访问 `/order/list`

3. **点击"新增订单"按钮**
   - 在页面右上角找到"新增订单"按钮
   - 点击按钮打开创建订单对话框

4. **选择会员**
   - 从下拉框中选择要预约的会员
   - 下拉框显示会员姓名和当前余额
   - 支持搜索功能快速定位会员

5. **选择课程**
   - 从下拉框中选择课程
   - 显示课程名称、教练姓名、费用、时间
   - 已被预订的课程会自动禁用（灰色显示）
   - 支持搜索功能

6. **确认信息**
   - 查看选择的课程费用
   - 查看会员当前余额
   - 系统会自动判断余额是否充足：
     - ✅ 余额充足：绿色提示"可以正常预约"
     - ❌ 余额不足：红色警告"余额不足"

7. **点击"确定创建"**
   - 如果余额充足，订单创建成功
   - 系统自动扣除会员余额
   - 创建预订记录和支付记录

8. **查看结果**
   - 对话框关闭
   - 订单列表自动刷新
   - 新订单显示在列表中

## 📱 界面说明

### 对话框字段

| 字段 | 说明 | 必填 |
|------|------|------|
| 选择会员 | 从会员列表中选择，显示余额信息 | ✅ 是 |
| 选择课程 | 从课程列表中选择，显示详细信息 | ✅ 是 |

### 课程信息展示

在课程下拉框中显示：
```
课程名称 - 教练姓名 (¥费用)
费用: ¥XXX | 时间: MM-DD HH:mm
```

### 余额检查提示

**余额充足**：
```
类型: 成功提示（绿色）
内容: 会员余额充足，可以正常预约
```

**余额不足**：
```
类型: 错误提示（红色）
内容: 会员余额不足，当前余额 ¥XXX，需要 ¥YYY
按钮: 被禁用，无法提交
```

## 🔧 技术实现

### 后端流程

```
1. 接收创建订单请求
   ↓
2. 检查课程是否已被预订
   ↓
3. 获取课程信息（验证课程存在）
   ↓
4. 获取会员余额
   ↓
5. 检查余额是否充足
   ↓
6. 开启事务
   ↓
7. 创建预订记录 (gym_booking)
   ↓
8. 更新课程状态 (gym_courses.isEnrolled = '1')
   ↓
9. 扣除会员余额 (gym_member_cards.member_fee)
   ↓
10. 创建支付记录 (gym_payments)
   ↓
11. 提交事务
   ↓
12. 返回成功结果
```

### 前端验证

```
1. 表单验证
   - 必须选择会员
   - 必须选择课程
   ↓
2. 业务逻辑验证
   - 会员余额 >= 课程费用
   ↓
3. 提交请求
   ↓
4. 处理响应
   - 成功：刷新列表，关闭对话框
   - 失败：显示错误信息
```

## 📊 数据变更

创建订单成功后，数据库变更：

### gym_courses（课程表）
```sql
UPDATE gym_courses SET isEnrolled = '1' WHERE course_id = ?;
```
- 课程状态变为"已预订"

### gym_booking（预订表）
```sql
INSERT INTO gym_booking (user_id, course_id, booking_date, isEnrolledByCurrentUser)
VALUES (?, ?, NOW(), '1');
```
- 创建新的预订记录

### gym_member_cards（会员卡表）
```sql
UPDATE gym_member_cards SET member_fee = member_fee - ? WHERE user_id = ?;
```
- 扣除会员余额

### gym_payments（支付表）
```sql
INSERT INTO gym_payments (user_id, booking_id, amount, payment_type, payment_status, payment_date)
VALUES (?, ?, ?, '管理员代预订', '1', NOW());
```
- 创建支付记录
- 支付方式标记为"管理员代预订"
- 支付状态为"已支付"

## 📝 接口文档

### 创建订单接口

**接口地址**: `POST /order/create`

**请求头**:
```
token: <JWT_TOKEN>
Content-Type: application/json
```

**请求体**:
```json
{
  "userId": 101,
  "courseId": 201
}
```

**请求参数说明**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| userId | Long | ✅ 是 | 会员ID |
| courseId | Long | ✅ 是 | 课程ID |

**成功响应**:
```json
{
  "code": 1,
  "msg": "success",
  "data": "订单创建成功"
}
```

**失败响应**:
```json
{
  "code": 0,
  "msg": "该课程已被其他会员预订"
}
```

```json
{
  "code": 0,
  "msg": "会员余额不足，当前余额: 50.00，需要金额: 80.00"
}
```

## 💡 使用场景

### 场景1：前台接待替会员预约
- 会员在健身房前台要求预约课程
- 管理员在系统中选择会员和课程
- 系统自动扣除余额并创建订单

### 场景2：电话预约
- 会员通过电话预约
- 管理员在系统中录入预约信息
- 完成后续的支付和预订流程

### 场景3：团体预约
- 企业团体预约课程
- 管理员批量创建多个订单
- 统一管理团体会员的课程安排

## ⚠️ 注意事项

1. **课程预订状态**:
   - 每个课程只能被一个会员预订
   - 已被预订的课程会显示为禁用状态

2. **余额检查**:
   - 创建订单前会检查余额
   - 余额不足时无法提交
   - 建议先为会员充值

3. **事务管理**:
   - 订单创建采用事务管理
   - 任何一步失败都会回滚
   - 保证数据一致性

4. **支付标记**:
   - 管理员创建的订单，支付方式标记为"管理员代预订"
   - 便于后续区分不同渠道的订单

5. **操作日志**:
   - 所有订单创建操作都会记录日志
   - 包含操作人、时间、参数等信息

## 🔍 与会员端的区别

| 功能 | 会员端 | 管理员端 |
|------|---------|-----------|
| 预约课程 | ✅ 自己预约 | ✅ 替会员预约 |
| 查看订单 | ✅ 只能看到自己的 | ✅ 可以看到所有订单 |
| 余额检查 | ✅ 实时检查 | ✅ 实时检查 |
| 支付方式 | "余额支付" | "管理员代预订" |
| 退课功能 | ✅ 支持退课 | ❌ 暂不支持 |

## 📚 相关文件

**后端文件**:
- `gym-pojo/src/main/java/com/sjdddd/dto/OrderCreateDTO.java` ✨ 新建
- `gym-server/src/main/java/com/sjdddd/mapper/OrderMapper.java` ✏️ 修改
- `gym-server/src/main/resources/mapper/OrderMapper.xml` ✏️ 修改
- `gym-server/src/main/java/com/sjdddd/service/OrderService.java` ✏️ 修改
- `gym-server/src/main/java/com/sjdddd/service/impl/OrderServiceImpl.java` ✏️ 修改
- `gym-server/src/main/java/com/sjdddd/controller/admin/OrderController.java` ✏️ 修改

**前端文件**:
- `gym-web/src/apis/order.ts` ✏️ 修改
- `gym-web/src/views/order/OrderList.vue` ✏️ 修改

**文档**:
- `ADMIN_CREATE_ORDER_FEATURE.md` ✨ 新建（本文档）

## 🆘 常见问题

### Q1: 为什么有些课程无法选择？
A: 已被预订的课程会自动禁用，显示为灰色。需要等待课程结束后才能重新预订。

### Q2: 会员余额不足怎么办？
A: 需要先为会员充值。当前版本管理员可以直接修改会员余额（如果有对应功能）或引导会员到充值页面。

### Q3: 创建订单失败后，余额会扣除吗？
A: 不会。由于使用了事务管理，任何步骤失败都会回滚，余额不会被扣除。

### Q4: 能否批量替多个会员创建订单？
A: 当前版本不支持批量创建，需要逐个创建订单。

### Q5: 如何查看管理员创建的订单？
A: 订单列表中会显示所有订单，支付方式为"管理员代预订"的即为管理员创建的订单。

### Q6: 管理员能否替会员退课？
A: 当前版本暂不支持。如需此功能，可以在后续版本中添加。

---

**开发者**: guess-you
**最后更新**: 2026-02-10
**版本**: 1.0.0
